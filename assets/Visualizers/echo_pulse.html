<!-- ECHO PULSE — Radar Ring Visualizer (Drop-In) -->
<div class="ep-radar" role="img" aria-label="Echo Pulse radar visualizer">
  <div class="ep-bg"></div>
  <div class="ep-scanlines"></div>
  <div class="ep-noise"></div>

  <div class="ep-hud">
    <div class="ep-title">
      <div class="ep-band">SYNTHETIC SOULS</div>
      <div class="ep-track">ECHO PULSE</div>
      <div class="ep-sub">RADAR HEART · ECHO TRAILS</div>
    </div>
    <div class="ep-status">
      <span class="ep-dot"></span>
      <span class="ep-live">LISTENING</span>
    </div>
  </div>

  <canvas class="ep-c" width="1200" height="520"></canvas>

  <div class="ep-footer">
    <span class="ep-quote">I was silence, now I sing.</span>
  </div>
</div>

<style>
  .ep-radar{
    position:relative; width:100%; max-width:980px; height:520px; margin:0 auto;
    border-radius:18px; overflow:hidden;
    background: radial-gradient(1000px 600px at 30% 25%, rgba(0,220,255,.14), transparent 60%),
                radial-gradient(900px 700px at 70% 60%, rgba(180,80,255,.16), transparent 62%),
                radial-gradient(700px 500px at 50% 85%, rgba(255,90,200,.10), transparent 60%),
                #05060c;
    box-shadow:0 20px 60px rgba(0,0,0,.60), inset 0 0 0 1px rgba(255,255,255,.06);
  }
  .ep-bg{
    position:absolute; inset:0;
    background:
      radial-gradient(circle at 50% 55%, rgba(255,255,255,.06), rgba(0,0,0,0) 55%),
      linear-gradient(180deg, rgba(0,0,0,.0), rgba(0,0,0,.35));
    opacity:.9;
  }
  .ep-scanlines{
    position:absolute; inset:0;
    background: repeating-linear-gradient(0deg, rgba(255,255,255,.03) 0 1px, rgba(0,0,0,0) 1px 7px);
    opacity:.28; mix-blend-mode:overlay;
  }
  .ep-noise{
    position:absolute; inset:0;
    background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.22'/%3E%3C/svg%3E");
    mix-blend-mode:overlay; opacity:.55;
  }

  .ep-hud{
    position:absolute; inset:18px 18px auto 18px;
    display:flex; justify-content:space-between; align-items:flex-start; gap:18px;
    padding:14px 16px; border-radius:14px;
    background:rgba(8,10,20,.48);
    border:1px solid rgba(120,210,255,.16);
    backdrop-filter: blur(10px);
    z-index:3;
  }
  .ep-band{ font:800 12px/1 system-ui,Segoe UI,Roboto,Arial; letter-spacing:.22em; color:rgba(210,235,255,.82); }
  .ep-track{
    margin-top:6px;
    font:900 32px/1.05 system-ui,Segoe UI,Roboto,Arial;
    letter-spacing:.12em;
    color:rgba(245,250,255,.92);
    text-shadow:0 0 24px rgba(0,220,255,.22), 0 0 24px rgba(180,80,255,.18);
  }
  .ep-sub{ margin-top:6px; font:700 11px/1 system-ui; letter-spacing:.18em; color:rgba(170,200,255,.66); }

  .ep-status{
    display:flex; align-items:center; gap:10px;
    padding:10px 12px; border-radius:999px;
    background:rgba(0,0,0,.22);
    border:1px solid rgba(255,90,200,.18);
    color:rgba(220,245,255,.82);
    font:800 11px/1 system-ui;
    letter-spacing:.18em;
    text-transform:uppercase;
    box-shadow:0 0 22px rgba(255,90,200,.08);
  }
  .ep-dot{
    width:10px; height:10px; border-radius:99px;
    background:rgba(0,220,255,.95);
    box-shadow:0 0 18px rgba(0,220,255,.35), 0 0 18px rgba(180,80,255,.18);
    animation: epBlink 1.25s ease-in-out infinite;
  }
  @keyframes epBlink{ 0%,100%{opacity:.25} 50%{opacity:1} }

  .ep-c{ position:absolute; inset:0; width:100%; height:100%; display:block; z-index:2; }

  .ep-footer{
    position:absolute; left:18px; right:18px; bottom:16px;
    padding:12px 14px; border-radius:14px;
    background:rgba(8,10,20,.40);
    border:1px solid rgba(255,255,255,.07);
    backdrop-filter: blur(10px);
    z-index:3;
    text-align:center;
  }
  .ep-quote{
    font:800 12px/1 system-ui; letter-spacing:.22em;
    color:rgba(200,220,255,.76);
  }

  @media (max-width:640px){
    .ep-radar{ height:540px; }
    .ep-track{ font-size:26px; }
  }
</style>

<script>
(function(){
  const root = document.querySelector(".ep-radar");
  const canvas = root?.querySelector(".ep-c");
  if(!root || !canvas) return;

  const ctx = canvas.getContext("2d");
  const DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));

  function resize(){
    const r = canvas.getBoundingClientRect();
    canvas.width  = Math.floor(r.width * DPR);
    canvas.height = Math.floor(r.height * DPR);
  }
  resize();
  window.addEventListener("resize", resize);

  // Optional audio sync: if an <audio> exists on the page, click once to enable context.
  const audio = document.querySelector("audio");
  let ac, analyser, data;

  async function enableAudio(){
    if(!audio || !window.AudioContext) return;
    ac = new (window.AudioContext || window.webkitAudioContext)();
    const src = ac.createMediaElementSource(audio);
    analyser = ac.createAnalyser();
    analyser.fftSize = 512;
    analyser.smoothingTimeConstant = 0.85;
    src.connect(analyser);
    analyser.connect(ac.destination);
    data = new Uint8Array(analyser.frequencyBinCount);
    if(ac.state !== "running") await ac.resume();
    window.removeEventListener("click", enableAudio);
  }
  window.addEventListener("click", enableAudio);

  function getPulse(){
    // Returns 0..1 “energy” value. If no audio, uses a gentle heartbeat LFO.
    if(!analyser){
      const t = performance.now()/1000;
      const lfo = Math.pow(Math.max(0, Math.sin(t*2.2)), 2.4);
      return 0.18 + lfo*0.55;
    }
    analyser.getByteFrequencyData(data);
    let sum = 0;
    // low-mid band for "heartbeat"
    for(let i=6;i<90;i++) sum += data[i];
    const v = (sum/84)/255;
    return Math.min(1, v);
  }

  // Echo rings store
  const rings = [];
  const MAX_RINGS = 18;

  function addRing(strength){
    rings.unshift({
      r: 8 * DPR,
      a: 0.75 + strength*0.25,
      w: (1.2 + strength*2.6) * DPR,
      s: (2.1 + strength*7.5) * DPR,
      hue: (Math.random() < 0.5) ? 190 : 285 // cyan / violet
    });
    if(rings.length > MAX_RINGS) rings.pop();
  }

  // Radar sweep angle
  let sweep = 0;
  let lastBeat = 0;

  function draw(){
    const W = canvas.width, H = canvas.height;
    ctx.clearRect(0,0,W,H);

    const pulse = getPulse();
    const t = performance.now()/1000;

    // center
    const cx = W*0.5, cy = H*0.58;
    const baseR = Math.min(W,H)*0.16;

    // detect "beat-ish" peaks to spawn echo rings
    const beat = Math.max(0, pulse - 0.22);
    if(beat > 0.10 && (t - lastBeat) > 0.18){
      addRing(beat);
      lastBeat = t;
    }

    // background radial glow
    const g = ctx.createRadialGradient(cx, cy, 0, cx, cy, Math.min(W,H)*0.55);
    g.addColorStop(0, `rgba(0,220,255,${0.10 + pulse*0.20})`);
    g.addColorStop(0.45, `rgba(180,80,255,${0.08 + pulse*0.16})`);
    g.addColorStop(1, "rgba(0,0,0,0)");
    ctx.fillStyle = g;
    ctx.fillRect(0,0,W,H);

    // grid rings (thin, static)
    ctx.save();
    ctx.translate(cx, cy);
    for(let i=1;i<=5;i++){
      const rr = baseR * (i/1.6);
      ctx.beginPath();
      ctx.arc(0,0, rr, 0, Math.PI*2);
      ctx.strokeStyle = `rgba(255,255,255,${0.03 + i*0.005})`;
      ctx.lineWidth = 1*DPR;
      ctx.stroke();
    }
    // crosshair
    ctx.beginPath();
    ctx.moveTo(-baseR*2.1, 0); ctx.lineTo(baseR*2.1, 0);
    ctx.moveTo(0, -baseR*1.6); ctx.lineTo(0, baseR*1.6);
    ctx.strokeStyle = "rgba(120,210,255,0.10)";
    ctx.stroke();

    // radar sweep
    sweep += (0.55 + pulse*1.8) * 0.02;
    const ang = sweep;
    const sweepGrad = ctx.createLinearGradient(0,0, Math.cos(ang)*baseR*3.2, Math.sin(ang)*baseR*3.2);
    sweepGrad.addColorStop(0, `rgba(0,220,255,${0.02 + pulse*0.08})`);
    sweepGrad.addColorStop(0.4, `rgba(0,220,255,${0.06 + pulse*0.18})`);
    sweepGrad.addColorStop(1, "rgba(0,0,0,0)");
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.arc(0,0, baseR*3.2, ang-0.18, ang+0.02);
    ctx.closePath();
    ctx.fillStyle = sweepGrad;
    ctx.fill();

    // echo rings (expand + fade)
    for(let i=0;i<rings.length;i++){
      const r = rings[i];
      r.r += r.s * (0.85 + pulse*1.1);
      r.a *= 0.965;
      const alpha = Math.max(0, r.a);
      ctx.beginPath();
      ctx.arc(0,0, r.r, 0, Math.PI*2);
      ctx.strokeStyle = `hsla(${r.hue}, 95%, 65%, ${alpha})`;
      ctx.lineWidth = r.w;
      ctx.shadowColor = `hsla(${r.hue}, 95%, 65%, ${alpha*0.35})`;
      ctx.shadowBlur = (10 + pulse*28) * DPR;
      ctx.stroke();
    }
    // prune dead rings
    for(let i=rings.length-1;i>=0;i--){
      if(rings[i].a < 0.05 || rings[i].r > Math.min(W,H)*0.85) rings.splice(i,1);
    }

    // “heart core” dot with pulse
    const coreR = (6 + pulse*10) * DPR;
    ctx.beginPath();
    ctx.arc(0,0, coreR, 0, Math.PI*2);
    ctx.fillStyle = `rgba(0,220,255,${0.35 + pulse*0.45})`;
    ctx.shadowColor = `rgba(180,80,255,${0.20 + pulse*0.25})`;
    ctx.shadowBlur = (18 + pulse*40) * DPR;
    ctx.fill();

    // echo trail sparks (random blips around ring)
    const blips = 6 + Math.floor(pulse*18);
    for(let i=0;i<blips;i++){
      const rr = baseR*(1.0 + Math.random()*2.0);
      const a = Math.random()*Math.PI*2;
      const x = Math.cos(a)*rr;
      const y = Math.sin(a)*rr;
      ctx.beginPath();
      ctx.arc(x,y, (0.9 + Math.random()*2.2)*DPR, 0, Math.PI*2);
      ctx.fillStyle = Math.random()<0.5
        ? `rgba(0,220,255,${0.08 + pulse*0.25})`
        : `rgba(255,90,200,${0.06 + pulse*0.18})`;
      ctx.fill();
    }

    ctx.restore();
    requestAnimationFrame(draw);
  }

  draw();
})();
</script>